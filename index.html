<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>My app</title>
		<style>
			body { margin: 0; }
			canvas { display: block; }
		</style>

		<script src="js/three.js"></script>
		<script src="js/OrbitControls.js"></script>
	</head>

	<body>
		<script type="module">

			import * as THREE from './three/build/three.module.js';
			import Stats from './three/examples/jsm/libs/stats.module.js';
			import { OrbitControls } from './three/examples/jsm/controls/OrbitControls.js';
			import { GLTFLoader } from './three/examples/jsm/loaders/GLTFLoader.js';
			import TWEEN from './js/tween.esm.js';
			var scene, camera, renderer, controls, stats;
			var model, skeleton_helper, clock;
			var done_loading, running = 'false';

			init();
			animate();

			var axis = new THREE.Vector3(1,0,0);

			var torso_joint_1;
			var torso_joint_2;
			var torso_joint_3;
			var neck_joint_1;
			var neck_joint_2;
			var arm_joint_L_1;
			var arm_joint_L_2;
			var arm_joint_L_3;
			var arm_joint_R_1;
			var arm_joint_R_2;
			var arm_joint_R_3;
			var leg_joint_L_1;
			var leg_joint_L_2;
			var leg_joint_L_3;
			var leg_joint_L_4;
			var leg_joint_R_1;
			var leg_joint_R_2;
			var leg_joint_R_3;
			var leg_joint_R_4;

			var i= 0;

			function init(){
				//SCENE
				scene= new THREE.Scene();
				scene.background = new THREE.Color(0xa0a0a0);
				scene.fog = new THREE.Fog(0xa0a0a0,10, 50);

				//CLOCK
				clock = new THREE.Clock();


				//CAMERA
				camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000 );
				camera.position.set(1, 2, 3);
				scene.add(camera);


				//LIGHTS
				var hemilight = new THREE.HemisphereLight(0xffffff);
				hemilight.position.set(0, 20, 0);
				scene.add(hemilight);

				var dirlight = new THREE.DirectionalLight(0xffffff);
				dirlight.position.set(-3, 10, -10);
				dirlight.castShadow = true;
				dirlight.shadow.camera.top = 2;
				dirlight.shadow.camera.bottom = -2;
				dirlight.shadow.camera.left = -2;
				dirlight.shadow.camera.right = 2;
				dirlight.shadow.camera.near = 0.1;
				dirlight.shadow.camera.far = 40;
				scene.add(dirlight);

				//RENDERER
				renderer = new THREE.WebGLRenderer( {antialias:true} );
				renderer.setPixelRatio(window.devicePixelRatio);
				renderer.shadowMap.enabled = true;
				renderer.setSize(window.innerWidth, window.innerHeight);
				document.body.appendChild(renderer.domElement);

				//STATS
				stats = new Stats();
				document.body.appendChild(stats.dom);
				var axes_helper = new THREE.AxesHelper(10);
				scene.add(axes_helper)

				//CONTROLS
				controls = new OrbitControls(camera, renderer.domElement);

				//FLOOR
				// instantiate a loader
				var loader = new THREE.TextureLoader();
				//load a resource
				var floor_texture = loader.load(
    			// resource URL
    				'./textures/unnamed.png',
    				// Function when resource is loaded
    				function ( texture ) {
        				// do something with the texture
        				var material = new THREE.MeshBasicMaterial( { map: texture } );
    				}
				);
				floor_texture.wrapS = floor_texture.wrapT = THREE.RepeatWrapping;
				floor_texture.repeat.set(50,50);
				var floor_material = new THREE.MeshBasicMaterial({map: floor_texture });
				var floor_geometry = new THREE.PlaneGeometry(1000, 1000, 10, 10);
				var floor = new THREE.Mesh(floor_geometry, floor_material);
				floor.rotation.x = -Math.PI/2;
				scene.add(floor);


				//LOADER
				var loader = new GLTFLoader();
				loader.load('./assets/RiggedFigure.glb', function(glb){
					model = glb.scene;
					scene.add(model);

					model.traverse(function(object){
						if(object.isMesh) object.castShadow = true;
						console.log(object);
						//PLEASE CHANGE TO SWITCH CASE THX LOL
						if(object.name == 'torso_joint_1'){
							torso_joint_1 = object;
						}
						else if(object.name == 'torso_joint_2'){
							torso_joint_2 = object;
						}
						else if(object.name == 'torso_joint_3'){
							torso_joint_3 = object;
						}
						else if(object.name == 'arm_joint_L_1'){
							arm_joint_L_1 = object;
						}
						else if(object.name == 'arm_joint_L_2'){
							arm_joint_L_2 = object;
						}
						else if(object.name == 'arm_joint_L_3'){
							arm_joint_L_3 = object;
						}
						else if(object.name == 'arm_joint_R_1'){
							arm_joint_R_1 = object;
						}
						else if(object.name == 'arm_joint_R_2'){
							arm_joint_R_2 = object;
						}
						else if(object.name == 'arm_joint_R_3'){
							arm_joint_R_3 = object;
						}
						else if(object.name == 'leg_joint_L_1'){
							leg_joint_L_1 = object;
						}
						else if(object.name == 'leg_joint_L_2'){
							leg_joint_L_2 = object;
						}
						else if(object.name == 'leg_joint_L_3'){
							leg_joint_L_3 = object;
						}
						else if(object.name == 'leg_joint_L_5'){
							leg_joint_L_4 = object;
						}
						else if(object.name == 'leg_joint_R_1'){
							leg_joint_R_1 = object;
						}
						else if(object.name == 'leg_joint_R_2'){
							leg_joint_R_2 = object;
						}
						else if(object.name == 'leg_joint_R_3'){
							leg_joint_R_3 = object;
						}
						else if(object.name == 'leg_joint_R_5'){
							leg_joint_R_4 = object;
						}
					});

					controls.update();

					skeleton_helper = new THREE.SkeletonHelper(model);
					skeleton_helper.material.linewidth = 5;
					skeleton_helper.visible=true;
					scene.add(skeleton_helper);
					done_loading = 'true';
					/*
					mixer = new THREE.AnimationMixer(model);
					var anim = glb.animations;
					console.log(anim);

					action = mixer.clipAction(anim[0]);
					action.play();*/
				},

				// called while loading is progressing
				function ( xhr ) {
					console.log( ( xhr.loaded / xhr.total * 100 ) + '% loaded' );
				},
				// called when loading has errors
				function ( error ) {
					console.log( 'An error happened: '+ error );
				});
			};



			document.addEventListener('keydown', onKeyDown, false);
			document.addEventListener('keyup', onKeyUp, false);
			function onKeyDown(event){
				var key = event.which;
				if(key == 87){
					if(running == 'false'){
						running = 'true';
						run();
					}
				}
			};
			function onKeyUp(event){
				var key = event.which;
				if(key == 87){
					running = 'false';
				}
			};


			function run(){
				i+=0.1;

				model.position.z += i/100;
				
				var tween_start_L = new TWEEN.Tween([leg_joint_L_1.rotation, leg_joint_L_2.rotation]).to([{x:2.5}, {x:-0.47, y:0.564, z:0.255}], 500).start();

				tween_start_L.onComplete(function(){
					var tween_middle1_L = new TWEEN.Tween([leg_joint_L_1.rotation, leg_joint_L_2.rotation]).to([{x:0}, {x:-1.9, y: 0.1, z: 0.65}], 500).start();
					
					tween_middle1_L.onComplete(function(){
						var tween_middle2_L = new TWEEN.Tween(leg_joint_L_2.rotation).to({x: 0.2, y: 0.5, z: 0.0}, 500).start();
						
						tween_middle2_L.onComplete(function(){
							var tween_end_L = new TWEEN.Tween([leg_joint_L_1.rotation, leg_joint_L_2.rotation]).to([{x: 1.412, y: 0.591, z: -3.108}, {x: -0.521, y:0.564, z: 0.255}],500).start();
							
							tween_end_L.onComplete(function(){
								running = 'false';
							});
						});
					});
				});


				var tween_start_R = new TWEEN.Tween(leg_joint_R_1.rotation).to({x:0.5}, 500).start();
				tween_start_R.onComplete(function(){
					var tween_middle_R = new TWEEN.Tween([leg_joint_R_1.rotation, leg_joint_R_2.rotation]).to([{x: 1.4, y: -0.1, z: 3.1}, {x: -0.52, y:-0.16, z: 0.01}], 500).start();
					tween_middle_R.onComplete(function(){
						var tween_end_R = new TWEEN.Tween([leg_joint_R_1.rotation, leg_joint_R_2.rotation]).to([{x:2.5}, {x:-1.9, y: -0.16, z: 0.01}], 500).start();
					});
				});

				var model_movement_tween = new TWEEN.Tween(model.position).to({z: model.position.z + 1}, 2000).start();

				var camera_movement_tween = new TWEEN.Tween(camera.position).to({z: camera.position.z + 1}, 2000).start();
				controls.update();

				console.log(camera.position);
			};




			function animate(){
				requestAnimationFrame(animate);
				var mixerUpdateDelta = clock.getDelta();
				if(done_loading == 'true'){
					controls.update();
					TWEEN.update();
				}
				//camera.translateZ(-1);
				controls.update();
				stats.update();
				renderer.render(scene, camera);
			};



		</script>
	</body>